<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiPrinzio</title>
    <link rel="stylesheet" href="/static/css/dashboard.css">
    
</head>
<body>
    <!-- Password Modal -->
    <div class="password-modal" id="passwordModal">
        <div class="password-box">
            <h2>Enter Password</h2>
            <input type="password" id="passwordInput" placeholder="Password" onkeypress="handlePasswordKeyPress(event)">
            <button onclick="checkPassword()">Enter</button>
            <div class="password-error" id="passwordError">Invalid password</div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1 style="font-size: 20px; font-weight: 600;">DiPrinzio</h1>
            </div>
            <div class="header-right">
                <div class="connection-status rpi" id="rpiConnectionStatus">
                    <div class="connection-dot" id="rpiConnectionDot"></div>
                    <span id="rpiConnectionText">RPi: Checking...</span>
                </div>
                <div class="connection-status server" id="serverConnectionStatus">
                    <div class="connection-dot" id="serverConnectionDot"></div>
                    <span id="serverConnectionText">Server: Connected</span>
                </div>
                <button id="systemToggleBtn" class="enabled" onclick="toggleSystem()">Disable System</button>
                <div class="theme-toggle" onclick="toggleTheme()">
                    <span id="themeIcon">‚òÄÔ∏è</span>
                </div>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-pill present">
                <span class="label">Present:</span>
                <span class="value" id="presentCount">0</span>
            </div>
            <div class="stat-pill">
                <span class="label">Registered:</span>
                <span class="value" id="totalCount">0</span>
            </div>
            <div class="stat-pill unlabeled">
                <span class="label">Unlabeled:</span>
                <span class="value" id="unlabeledCount">0</span>
            </div>
            <div class="stat-pill">
                <span class="label">Vectors:</span>
                <span class="value" id="vectorCount">0</span>
            </div>

            <div class="auto-refresh-toggle" onclick="toggleAutoRefresh()">
                <span>Auto-refresh</span>
                <div class="toggle-switch active" id="autoRefreshSwitch">
                    <div class="toggle-slider"></div>
                </div>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Left Column: Activity Feed -->
            <div class="activity-feed">
                <h3>Recent Activity</h3>
                <div id="activityList"></div>
            </div>

            <!-- Right Column: Who's Here + Summary -->
            <div class="sidebar-grid">
                <div class="whos-here">
                    <h3>Currently In Office (<span id="presentCountInline">0</span>)</h3>
                    <div id="presentList"></div>
                </div>

                <div class="summary-card">
                    <h3>Today's Summary</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Total Entries</div>
                            <div class="summary-value" id="todayEntries">0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Unique Visitors</div>
                            <div class="summary-value" id="todayUnique">0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">New Unlabeled</div>
                            <div class="summary-value" id="todayUnlabeled">0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Peak Time</div>
                            <div class="summary-value" id="peakTime">--:--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Camera Settings Section (Always Visible) -->
        <div class="camera-settings-section" style="margin-bottom: 24px;">
            <div class="section-header" style="margin-bottom: 12px;">Camera Controls</div>
            <div class="control-buttons">
                <button class="camera-btn view-stream" onclick="viewCamera()">View Live Stream</button>
                <button class="camera-btn register" onclick="registerViaRPi()">Register New Person</button>
                <button class="camera-btn calibrate" onclick="calibrateRPi()">Calibrate Tripwires</button>
            </div>
        </div>

        <!-- Divider between Camera Controls and Search -->
        <div style="height: 1px; background: var(--border-color); margin: 20px 0;"></div>

        <!-- Search & Filter -->
        <div class="search-filter">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search people..." oninput="filterPeople()">
            </div>
            <select class="filter-select" id="filterSelect" onchange="filterPeople()">
                <option value="all">All People</option>
                <option value="present">Present Only</option>
                <option value="unlabeled">Unlabeled Only</option>
            </select>
        </div>

        <!-- Control Tabs -->
        <div class="control-tabs">
            <button class="tab-button active" onclick="switchTab('unlabeled')">Unlabeled</button>
            <button class="tab-button" onclick="switchTab('people')">All People</button>
        </div>

        <!-- Unlabeled Tab -->
        <div class="tab-panel active" id="unlabeledTab">
            <div class="section-header">Click any card to label the person</div>
            <div class="people-grid" id="unlabeledGrid"></div>
        </div>

        <!-- All People Tab -->
        <div class="tab-panel" id="peopleTab">
            <div class="people-grid" id="allPeopleGrid"></div>
        </div>

        <!-- Database Management Section (Bottom) -->
        <div class="db-management-container">
            <div class="section-header" style="margin-bottom: 16px;">Database Management</div>
            
            <!-- Full State Section -->
            <div style="margin-bottom: 20px;">
                <div class="section-header" style="font-size: 12px; margin-bottom: 8px; color: var(--text-secondary); font-weight: 400;">Full State Backup</div>
                <div class="control-buttons">
                    <button class="db-btn" onclick="downloadFullState()">Download Full State</button>
                    <button class="db-btn" onclick="document.getElementById('fullStateUploadInput').click()">Upload Full State</button>
                    <input type="file" id="fullStateUploadInput" accept=".json" style="display: none;" onchange="uploadFullState(event)">
                </div>
            </div>

            <!-- Vector DB Section -->
            <div style="margin-bottom: 20px;">
                <div class="section-header" style="font-size: 12px; margin-bottom: 8px; color: var(--text-secondary); font-weight: 400;">Vector Database Only</div>
                <div class="control-buttons">
                    <button class="db-btn" onclick="downloadVectorDB()">Download Vector DB</button>
                    <button class="db-btn" onclick="document.getElementById('vectorUploadInput').click()">Upload Vector DB</button>
                    <input type="file" id="vectorUploadInput" accept=".json" style="display: none;" onchange="uploadVectorDB(event)">
                </div>
            </div>

            <!-- Vector Analysis Section -->
            <div>
                <div class="section-header" style="font-size: 12px; margin-bottom: 8px; color: var(--text-secondary); font-weight: 400;">Vector Analysis</div>
                <div class="control-buttons">
                    <button class="db-btn" id="showSimilarityMatrixBtn" onclick="window.showSimilarityMatrix ? window.showSimilarityMatrix() : console.error('showSimilarityMatrix not available');">View Similarity Matrix</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Person Detail Modal -->
    <div class="modal" id="personDetailModal">
        <div class="modal-content">
            <h2>Person Details</h2>
            <div class="person-detail">
                <img id="detailImage" class="person-detail-image" src="" alt="">
                <div class="person-detail-info">
                    <div class="person-detail-field">
                        <label>ID:</label>
                        <span class="value" id="detailId"></span>
                    </div>
                    <div class="person-detail-field">
                        <label>Name:</label>
                        <input type="text" id="detailNameInput" placeholder="Enter name">
                    </div>
                    <div class="person-detail-field">
                        <label>State:</label>
                        <span class="value" id="detailState"></span>
                    </div>
                    <div class="person-detail-field" id="detailEnteredAtField" style="display: none;">
                        <label>Entered At:</label>
                        <span class="value" id="detailEnteredAt"></span>
                    </div>
                    <div class="person-detail-field" id="detailTimeInOfficeField" style="display: none;">
                        <label>Time In Office:</label>
                        <span class="value" id="detailTimeInOffice"></span>
                    </div>
                    <div class="person-detail-field" id="detailLastExitField" style="display: none;">
                        <label>Last Exit:</label>
                        <span class="value" id="detailLastExit"></span>
                    </div>
                    <div class="person-detail-field" id="detailSimilarityField" style="display: none;">
                        <label>Last Recognition Confidence:</label>
                        <span class="value" id="detailSimilarity"></span>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="secondary" onclick="closePersonModal()">Cancel</button>
                <button class="danger" onclick="deletePersonFromModal()">Delete</button>
                <button class="save-btn" onclick="savePersonDetails()">Save</button>
            </div>
        </div>
    </div>

    <!-- Live Camera Modal -->
    <div class="modal" id="cameraModal">
        <div class="modal-content">
            <h2>Live Camera View</h2>
            <div class="stream-container">
                <div class="stream-status">
                    <div class="status-dot streaming"></div>
                    <span id="streamStatus">Streaming at 5 FPS</span>
                </div>
                <img id="streamImg" class="stream-video" style="display: none;">
                <div id="streamPlaceholder" class="stream-placeholder">Starting stream...</div>
            </div>
            <div class="modal-actions">
                <button class="secondary" onclick="closeCameraModal()">Close</button>
                <button onclick="registerFromStream()">üì∑ Register Person</button>
            </div>
        </div>
    </div>

    <!-- Calibration Modal -->
    <div class="modal" id="calibrationModal">
        <div class="modal-content">
            <h2>Calibrate Tripwires</h2>
            <div class="calibration-info">
                <strong>Instructions:</strong> Drag the lines or type values to set detection zones<br>
                <span style="color: #ff0;">‚ñ† Yellow line</span> = Outer boundary (entrance)<br>
                <span style="color: #f00;">‚ñ† Red line</span> = Inner boundary (office)
            </div>
            <div class="stream-container" style="position: relative;">
                <canvas id="calibrationCanvas"></canvas>
                <div class="mouse-position" id="mousePosition">X: 0</div>
            </div>
            <div class="calibration-values">
                <div class="calibration-value">
                    <label>Outer X (Yellow):</label>
                    <input type="number" id="outerXInput" value="800" onchange="updateCalibrationFromInput()">
                </div>
                <div class="calibration-value">
                    <label>Inner X (Red):</label>
                    <input type="number" id="innerXInput" value="1800" onchange="updateCalibrationFromInput()">
                </div>
            </div>
            <div class="modal-actions">
                <button class="secondary" onclick="closeCalibrationModal()">Cancel</button>
                <button onclick="saveCalibration()">Save Tripwires</button>
            </div>
        </div>
    </div>

    <!-- RPi Status Modal -->
    <div class="modal" id="rpiStatusModal">
        <div class="modal-content">
            <h2>RPi Status Details</h2>
            <div id="rpiStatusDetails"></div>
            <div class="modal-actions">
                <button class="secondary" onclick="closeRPiStatusModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Similarity Matrix Modal -->
    <div class="modal" id="similarityMatrixModal">
        <div class="modal-content" style="max-width: 90vw; max-height: 90vh; overflow: auto;">
            <h2>Vector Similarity Matrix</h2>
            <div id="similarityMatrixContent">
                <div style="text-align: center; padding: 20px;">Loading...</div>
            </div>
            <div class="modal-actions">
                <button class="secondary" onclick="closeSimilarityMatrix()">Close</button>
            </div>
        </div>
    </div>

        <script src="/static/js/dashboard.js"></script>

</body>
</html>